name: Achievement Tracker

on:
  pull_request:
    types: [opened, closed]
  pull_request_review:
    types: [submitted]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  track-achievements:
    name: "üèÜ Track Achievements"
    runs-on: ubuntu-latest
    steps:
      - name: Check for achievements
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const actor = context.actor;
            const eventName = context.eventName;
            const action = context.payload.action;

            console.log(`Event: ${eventName}, Action: ${action}, Actor: ${actor}`);

            // Skip bots
            if (actor.includes('[bot]') || actor === 'github-actions') {
              console.log('Skipping bot actor');
              return;
            }

            // Achievement definitions
            const achievements = {
              'first-pr': {
                emoji: 'üéØ',
                name: 'First Pull Request',
                message: 'Welcome to Villa! You\'ve opened your first PR.'
              },
              'first-merge': {
                emoji: 'üöÄ',
                name: 'Code Shipped',
                message: 'Congratulations! Your code is now part of Villa.'
              }
            };

            // Helper: Check if user has previous PRs
            async function getPRCount(username) {
              const { data: prs } = await github.rest.pulls.list({
                owner,
                repo,
                state: 'all',
                per_page: 100
              });
              return prs.filter(pr => pr.user.login === username).length;
            }

            // Helper: Check if user has merged PRs
            async function getMergedPRCount(username) {
              const { data: prs } = await github.rest.pulls.list({
                owner,
                repo,
                state: 'closed',
                per_page: 100
              });
              return prs.filter(pr => pr.user.login === username && pr.merged_at).length;
            }

            // Helper: Add comment to PR
            async function addAchievementComment(prNumber, achievement) {
              const body = `## ${achievement.emoji} Achievement Unlocked: ${achievement.name}!\n\n${achievement.message}\n\n---\n*[View all achievements](../blob/main/CONTRIBUTING.md#achievements)*`;

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body
              });
            }

            // Helper: Add label to PR
            async function addLabel(prNumber, label) {
              try {
                await github.rest.issues.addLabels({
                  owner,
                  repo,
                  issue_number: prNumber,
                  labels: [label]
                });
              } catch (e) {
                console.log(`Could not add label ${label}: ${e.message}`);
              }
            }

            // Handle PR opened
            if (eventName === 'pull_request' && action === 'opened') {
              const prNumber = context.payload.pull_request.number;
              const prCount = await getPRCount(actor);

              console.log(`PR count for ${actor}: ${prCount}`);

              // First PR achievement (this is their only PR, including the current one)
              if (prCount === 1) {
                console.log(`First PR achievement for ${actor}!`);
                await addAchievementComment(prNumber, achievements['first-pr']);
                await addLabel(prNumber, 'first-pr');
              }
            }

            // Handle PR merged
            if (eventName === 'pull_request' && action === 'closed') {
              const pr = context.payload.pull_request;
              const prNumber = pr.number;

              if (pr.merged) {
                const mergedCount = await getMergedPRCount(actor);

                console.log(`Merged PR count for ${actor}: ${mergedCount}`);

                // First merge achievement (this is their only merged PR)
                if (mergedCount === 1) {
                  console.log(`First merge achievement for ${actor}!`);
                  await addAchievementComment(prNumber, achievements['first-merge']);
                  await addLabel(prNumber, 'achievement');
                }

                // Bug squasher (3+ bug fixes)
                if (pr.title.toLowerCase().startsWith('fix:') || pr.labels.some(l => l.name === 'bug')) {
                  const { data: allPRs } = await github.rest.pulls.list({
                    owner,
                    repo,
                    state: 'closed',
                    per_page: 100
                  });

                  const bugFixes = allPRs.filter(p =>
                    p.user.login === actor &&
                    p.merged_at &&
                    (p.title.toLowerCase().startsWith('fix:') || p.labels.some(l => l.name === 'bug'))
                  ).length;

                  if (bugFixes === 3) {
                    const bugAchievement = {
                      emoji: 'üêõ',
                      name: 'Bug Squasher',
                      message: 'You\'ve fixed 3 bugs! The codebase thanks you.'
                    };
                    await addAchievementComment(prNumber, bugAchievement);
                    await addLabel(prNumber, 'achievement');
                  }
                }

                // Trusted contributor (10+ merged PRs)
                if (mergedCount === 10) {
                  const trustedAchievement = {
                    emoji: 'üíé',
                    name: 'Trusted Contributor',
                    message: 'You\'ve merged 10 PRs! You\'re now eligible for maintainer status. Reach out to the repo owner!'
                  };
                  await addAchievementComment(prNumber, trustedAchievement);
                  await addLabel(prNumber, 'contributor-level-3');
                }
              }
            }

            console.log('Achievement tracking complete');
