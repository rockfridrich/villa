name: Deploy to DigitalOcean

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

env:
  REGISTRY: registry.digitalocean.com
  IMAGE_NAME: villa/villa-app

jobs:
  deploy-preview:
    name: Deploy Preview
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    environment:
      name: preview
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Deploy to App Platform (Preview)
        id: deploy
        run: |
          # Create or update preview app
          APP_NAME="villa-pr-${{ github.event.pull_request.number }}"

          # Check if app exists
          if doctl apps list --format Name --no-header | grep -q "^${APP_NAME}$"; then
            echo "Updating existing preview app..."
            APP_ID=$(doctl apps list --format ID,Name --no-header | grep "${APP_NAME}" | awk '{print $1}')
            doctl apps update $APP_ID --spec .do/app-preview.yaml
          else
            echo "Creating new preview app..."
            doctl apps create --spec .do/app-preview.yaml
          fi

          # Get app URL
          sleep 30
          APP_URL=$(doctl apps list --format DefaultIngress,Name --no-header | grep "${APP_NAME}" | awk '{print $1}')
          echo "url=https://${APP_URL}" >> $GITHUB_OUTPUT
          echo "Preview URL: https://${APP_URL}"

      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸš€ Preview Deployed!\n\n**URL:** ${{ steps.deploy.outputs.url }}\n\nThis preview will be automatically deleted when the PR is closed.`
            })

  deploy-production:
    name: Deploy Production
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://villa.proofofretreat.me
    steps:
      - uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Deploy to App Platform (Production)
        run: |
          # Update production app
          APP_ID=$(doctl apps list --format ID,Name --no-header | grep "villa-production" | awk '{print $1}')

          if [ -z "$APP_ID" ]; then
            echo "Creating production app..."
            doctl apps create --spec .do/app-production.yaml
          else
            echo "Updating production app..."
            doctl apps update $APP_ID --spec .do/app-production.yaml
          fi

      - name: Wait for deployment
        run: |
          APP_ID=$(doctl apps list --format ID,Name --no-header | grep "villa-production" | awk '{print $1}')
          echo "Waiting for deployment to complete..."
          for i in {1..30}; do
            STATUS=$(doctl apps get $APP_ID --format ActiveDeployment.Phase --no-header)
            if [ "$STATUS" = "ACTIVE" ]; then
              echo "Deployment successful!"
              exit 0
            fi
            echo "Status: $STATUS - waiting..."
            sleep 10
          done
          echo "Deployment timed out"
          exit 1

  cleanup-preview:
    name: Cleanup Preview
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Delete preview app
        run: |
          APP_NAME="villa-pr-${{ github.event.pull_request.number }}"
          APP_ID=$(doctl apps list --format ID,Name --no-header | grep "${APP_NAME}" | awk '{print $1}')

          if [ -n "$APP_ID" ]; then
            echo "Deleting preview app: ${APP_NAME}"
            doctl apps delete $APP_ID --force
          else
            echo "No preview app found for PR #${{ github.event.pull_request.number }}"
          fi
