name: Deploy

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, closed, ready_for_review]

permissions:
  contents: write
  pull-requests: write
  deployments: write

concurrency:
  group: deploy-${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.pull_request.number) || github.ref_name }}
  cancel-in-progress: true

env:
  # Domain architecture (CloudFlare DNS ‚Üí DigitalOcean)
  PRODUCTION_DOMAIN: villa.cash
  STAGING_DOMAIN: beta.villa.cash
  DEV_1_DOMAIN: dev-1.villa.cash
  DEV_2_DOMAIN: dev-2.villa.cash
  # GIFs for delightful bot messages
  GIF_SHIP: "https://media.giphy.com/media/ule4vhcY1xEKQ/giphy.gif"
  GIF_SUCCESS: "https://media.giphy.com/media/XreQmk7ETCak0/giphy.gif"
  GIF_THINKING: "https://media.giphy.com/media/3o7TKwmnDgQb5jemjK/giphy.gif"
  GIF_CELEBRATE: "https://media.giphy.com/media/l0MYt5jPR6QX5pnqM/giphy.gif"
  GIF_ROCKET: "https://media.giphy.com/media/mi6DsSSNKDbUY/giphy.gif"
  GIF_STAGING: "https://media.giphy.com/media/3o7btNa0RUYa5E7iiQ/giphy.gif"

jobs:
  # =============================================================================
  # QUICK CI - Always runs for PRs (fast feedback ~30s)
  # =============================================================================
  quick-ci:
    name: "‚ö° Quick CI"
    if: github.event_name == 'pull_request' && github.event.action != 'closed'
    runs-on: ubuntu-latest
    outputs:
      should-e2e: ${{ steps.check-paths.outputs.run }}
      dev-slot: ${{ steps.slot.outputs.slot }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: apps/web/.next/cache
          key: nextjs-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('**/*.ts', '**/*.tsx') }}
          restore-keys: |
            nextjs-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}-
            nextjs-${{ runner.os }}-

      - run: pnpm install --frozen-lockfile
      - run: pnpm run typecheck
      - run: pnpm run lint
      - run: pnpm --filter @villa/web exec vitest run --config vitest.config.unit.ts

      - name: Assign dev slot (1 or 2)
        id: slot
        run: |
          PR_NUM=${{ github.event.pull_request.number }}
          SLOT=$(( (PR_NUM % 2) + 1 ))
          echo "slot=${SLOT}" >> $GITHUB_OUTPUT
          echo "üìç PR #${PR_NUM} assigned to dev-${SLOT}.villa.cash"

      - name: Check if E2E needed
        id: check-paths
        run: |
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD 2>/dev/null || echo "src/")
          if echo "$CHANGED" | grep -qE '^(src/|tests/|playwright|package)'; then
            echo "run=true" >> $GITHUB_OUTPUT
          else
            echo "run=false" >> $GITHUB_OUTPUT
            echo "üìù Skipping E2E - only docs/config changes"
          fi

  # =============================================================================
  # E2E TESTS - Sharded for parallel execution
  # =============================================================================
  e2e-tests:
    name: "üß™ E2E (${{ matrix.shard }})"
    needs: quick-ci
    if: |
      github.event_name == 'pull_request' &&
      github.event.action != 'closed' &&
      github.event.pull_request.draft == false &&
      needs.quick-ci.outputs.should-e2e == 'true' &&
      !contains(github.event.pull_request.title, '[wip]') &&
      !contains(github.event.pull_request.title, '[skip e2e]')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2]
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      - uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter @villa/web exec playwright install --with-deps chromium
        if: steps.playwright-cache.outputs.cache-hit != 'true'
      - run: pnpm --filter @villa/web exec playwright install-deps chromium
        if: steps.playwright-cache.outputs.cache-hit == 'true'
      - run: pnpm --filter @villa/web exec playwright test --project=chromium --shard=${{ matrix.shard }}/2
        env:
          CI: true
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-shard-${{ matrix.shard }}
          path: playwright-report/
          retention-days: 7

  # =============================================================================
  # CHECK PERMISSION - For preview deploys
  # =============================================================================
  check-permission:
    name: "üîê Check Permission"
    if: |
      github.event_name == 'pull_request' &&
      github.event.action != 'closed' &&
      github.event.pull_request.draft == false &&
      !contains(github.event.pull_request.title, '[skip deploy]')
    runs-on: ubuntu-latest
    outputs:
      is-collaborator: ${{ steps.check.outputs.is-collaborator }}
    steps:
      - name: Check if PR author is collaborator
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const { data: permissionLevel } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: context.payload.pull_request.user.login
            });
            const hasAccess = ['admin', 'write', 'maintain'].includes(permissionLevel.permission);
            core.setOutput('is-collaborator', hasAccess);

  # =============================================================================
  # DEPLOY PREVIEW - To dev-1 or dev-2 based on PR number
  # =============================================================================
  deploy-preview:
    name: "üöÄ Deploy Preview (dev-${{ needs.quick-ci.outputs.dev-slot }})"
    needs: [quick-ci, check-permission]
    if: |
      github.event_name == 'pull_request' &&
      github.event.action != 'closed' &&
      github.event.pull_request.draft == false &&
      needs.check-permission.outputs.is-collaborator == 'true' &&
      !contains(github.event.pull_request.title, '[skip deploy]')
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.deploy.outputs.url }}
      slot: ${{ needs.quick-ci.outputs.dev-slot }}
    environment:
      name: preview-${{ needs.quick-ci.outputs.dev-slot }}
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Get PR info
        id: pr-info
        run: |
          COMMITS=$(git log --oneline origin/${{ github.base_ref }}..HEAD 2>/dev/null | head -5 || echo "Initial commit")
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Generate app spec
        run: |
          export DEV_SLOT="${{ needs.quick-ci.outputs.dev-slot }}"
          export PR_NUMBER="${{ github.event.pull_request.number }}"
          export BRANCH_NAME="${{ github.head_ref }}"
          envsubst < .do/app-preview.yaml > .do/app-preview-generated.yaml
          cat .do/app-preview-generated.yaml

      - name: Deploy to dev-${{ needs.quick-ci.outputs.dev-slot }}.villa.cash
        id: deploy
        env:
          DEV_SLOT: ${{ needs.quick-ci.outputs.dev-slot }}
        run: |
          APP_NAME="villa-dev-${DEV_SLOT}"
          DOMAIN="dev-${DEV_SLOT}.villa.cash"
          START_TIME=$(date +%s)

          APP_ID=$(doctl apps list --format ID,Spec.Name --no-header | grep "${APP_NAME}$" | awk '{print $1}')

          if [ -n "$APP_ID" ]; then
            echo "üì¶ Updating ${APP_NAME} (slot ${DEV_SLOT})..."
            doctl apps update $APP_ID --spec .do/app-preview-generated.yaml
          else
            echo "üÜï Creating ${APP_NAME}..."
            doctl apps create --spec .do/app-preview-generated.yaml
          fi

          # Wait for deployment
          for i in {1..30}; do
            APP_ID=$(doctl apps list --format ID,Spec.Name --no-header | grep "${APP_NAME}$" | awk '{print $1}')
            if [ -n "$APP_ID" ]; then
              APP_JSON=$(doctl apps get $APP_ID --output json 2>/dev/null || echo '[]')
              ACTIVE_PHASE=$(echo "$APP_JSON" | jq -r '.[0].active_deployment.phase // empty')
              if [ "$ACTIVE_PHASE" = "ACTIVE" ]; then
                END_TIME=$(date +%s)
                DURATION=$((END_TIME - START_TIME))
                echo "url=https://${DOMAIN}" >> $GITHUB_OUTPUT
                echo "duration=${DURATION}s" >> $GITHUB_OUTPUT
                echo "‚úÖ Deployed to https://${DOMAIN}"
                exit 0
              fi
            fi
            echo "‚è≥ Waiting for deployment... ($i/30)"
            sleep 10
          done
          echo "‚ùå Deployment timeout"
          exit 1

      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const url = '${{ steps.deploy.outputs.url }}';
            const duration = '${{ steps.deploy.outputs.duration }}';
            const sha = '${{ steps.pr-info.outputs.sha }}';
            const commits = `${{ steps.pr-info.outputs.commits }}`;
            const branch = '${{ github.head_ref }}';
            const slot = '${{ needs.quick-ci.outputs.dev-slot }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const body = `![Ship it!](https://media.giphy.com/media/ule4vhcY1xEKQ/giphy.gif)

            ## üöÄ Preview Ready on dev-${slot}!

            ### **[üîó ${url}](${url})** ‚Üê Click to test!

            | | |
            |---|---|
            | üè∑Ô∏è **Slot** | \`dev-${slot}.villa.cash\` |
            | üåø **Branch** | \`${branch}\` |
            | üìù **Commit** | \`${sha}\` |
            | ‚è±Ô∏è **Deploy time** | ${duration} |

            <details>
            <summary>üìã Recent commits</summary>

            \`\`\`
            ${commits}
            \`\`\`

            </details>

            ---
            <sub>ü§ñ Slot reused on PR close ‚Ä¢ [View Logs](${runUrl})</sub>`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c => c.user.type === 'Bot' && c.body.includes('Preview Ready'));

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body
              });
            }

  # =============================================================================
  # E2E PREVIEW - Test on dev slot
  # =============================================================================
  e2e-preview:
    name: "üß™ E2E (dev-${{ needs.deploy-preview.outputs.slot }})"
    needs: deploy-preview
    if: needs.deploy-preview.outputs.url
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter @villa/web exec playwright install --with-deps chromium

      - name: Wait for healthy deployment
        run: |
          URL="${{ needs.deploy-preview.outputs.url }}"
          for i in {1..20}; do
            if curl -sf "$URL/api/health" > /dev/null; then
              echo "‚úÖ Preview healthy"
              exit 0
            fi
            sleep 10
          done
          exit 1

      - name: Run E2E tests
        id: e2e
        run: pnpm run test:e2e:chromium 2>&1 | tee e2e-output.txt
        env:
          BASE_URL: ${{ needs.deploy-preview.outputs.url }}
          CI: true
        continue-on-error: true

      - name: Comment E2E results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const passed = '${{ steps.e2e.outcome }}' === 'success';
            const url = '${{ needs.deploy-preview.outputs.url }}';
            const slot = '${{ needs.deploy-preview.outputs.slot }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            let body;
            if (passed) {
              body = `![Tests passing](https://media.giphy.com/media/XreQmk7ETCak0/giphy.gif)

              ## ‚úÖ E2E Tests Passing on dev-${slot}!

              All tests passed.

              | | |
              |---|---|
              | üåê **Tested URL** | [${url}](${url}) |
              | üìä **Full Report** | [View Logs](${runUrl}) |

              ---
              <sub>ü§ñ Tests ran automatically on preview deploy</sub>`;
            } else {
              body = `## ‚ùå E2E Tests Need Attention

              Some tests failed on dev-${slot}.

              | | |
              |---|---|
              | üåê **Tested URL** | [${url}](${url}) |
              | üìä **Full Report** | [View Logs](${runUrl}) |

              ---
              <sub>ü§ñ Run \`npm run test:e2e:ui\` locally to debug</sub>`;
            }

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c => c.user.type === 'Bot' && c.body.includes('E2E Tests'));

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body
              });
            }

      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report-preview
          path: playwright-report/
          retention-days: 7

      - name: Fail if tests failed
        if: steps.e2e.outcome != 'success'
        run: exit 1

  # =============================================================================
  # STAGING CI - Runs on push to main (not tags)
  # =============================================================================
  ci-staging:
    name: "üîí CI (Staging)"
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      - uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
      - run: pnpm install --frozen-lockfile
      - run: pnpm run typecheck & pnpm run lint & wait
      - run: pnpm --filter @villa/web exec vitest run --config vitest.config.unit.ts
      - run: pnpm --filter @villa/web exec playwright install --with-deps chromium
        if: steps.playwright-cache.outputs.cache-hit != 'true'
      - run: pnpm --filter @villa/web exec playwright install-deps chromium
        if: steps.playwright-cache.outputs.cache-hit == 'true'
      - run: pnpm --filter @villa/web exec playwright test --project=chromium
        env:
          CI: true

  # =============================================================================
  # DEPLOY STAGING - To beta.villa.cash on push to main
  # =============================================================================
  deploy-staging:
    name: "üéØ Deploy Staging"
    needs: ci-staging
    if: needs.ci-staging.result == 'success'
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    environment:
      name: staging
      url: https://beta.villa.cash
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Get staging info
        id: staging-info
        run: |
          CHANGELOG=$(git log --oneline -10 --pretty=format:"- %s" | head -10)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          VERSION=$(node -p "require('./package.json').version")
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Deploy to beta.villa.cash
        id: deploy
        run: |
          START_TIME=$(date +%s)
          APP_ID=$(doctl apps list --format ID,Spec.Name --no-header | grep "villa-staging$" | awk '{print $1}')

          if [ -z "$APP_ID" ]; then
            echo "üÜï Creating staging app..."
            doctl apps create --spec .do/app-staging.yaml
          else
            echo "üì¶ Updating staging app..."
            doctl apps update $APP_ID --spec .do/app-staging.yaml

            # Force rebuild to ensure new code is deployed (fixes cache issues)
            echo "üî® Forcing rebuild with --force-rebuild..."
            doctl apps create-deployment $APP_ID --force-rebuild --wait=false
          fi

          # Wait for deployment
          for i in {1..30}; do
            APP_ID=$(doctl apps list --format ID,Spec.Name --no-header | grep "villa-staging$" | awk '{print $1}')
            if [ -n "$APP_ID" ]; then
              APP_JSON=$(doctl apps get $APP_ID --output json 2>/dev/null || echo '[]')
              IN_PROGRESS=$(echo "$APP_JSON" | jq -r '.[0].in_progress_deployment.phase // empty')
              if [ -n "$IN_PROGRESS" ]; then
                echo "üî® Building: $IN_PROGRESS ($i/30)"
                sleep 10
                continue
              fi
              ACTIVE_PHASE=$(echo "$APP_JSON" | jq -r '.[0].active_deployment.phase // empty')
              if [ "$ACTIVE_PHASE" = "ACTIVE" ]; then
                END_TIME=$(date +%s)
                DURATION=$((END_TIME - START_TIME))
                echo "url=https://beta.villa.cash" >> $GITHUB_OUTPUT
                echo "duration=${DURATION}s" >> $GITHUB_OUTPUT
                exit 0
              fi
            fi
            sleep 10
          done
          exit 1

      - name: Purge CloudFlare cache
        if: steps.deploy.outcome == 'success'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          if [ -n "$CLOUDFLARE_API_TOKEN" ] && [ -n "$CLOUDFLARE_ZONE_ID" ]; then
            echo "üóëÔ∏è Purging CloudFlare cache for beta.villa.cash..."
            pnpm run infra:cache:purge || echo "Cache purge failed (non-blocking)"
          else
            echo "‚ö†Ô∏è CloudFlare secrets not configured, skipping cache purge"
          fi

      - name: Create staging comment
        uses: actions/github-script@v7
        with:
          script: |
            const url = 'https://beta.villa.cash';
            const duration = '${{ steps.deploy.outputs.duration }}';
            const version = '${{ steps.staging-info.outputs.version }}';
            const sha = '${{ steps.staging-info.outputs.sha }}';
            const changelog = `${{ steps.staging-info.outputs.changelog }}`;
            const actor = '${{ github.actor }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const commitMsg = context.payload.head_commit?.message?.split('\n')[0] || 'Staging deploy';

            const body = `![Staging!](https://media.giphy.com/media/3o7btNa0RUYa5E7iiQ/giphy.gif)

            ## üéØ Deployed to Staging!

            ### **[üîó beta.villa.cash](${url})** ‚Üê Test before release

            | | |
            |---|---|
            | üì¶ **Version** | \`v${version}\` |
            | üìù **Commit** | \`${sha}\` - ${commitMsg} |
            | ‚è±Ô∏è **Deploy time** | ${duration} |
            | üë§ **Deployed by** | @${actor} |

            <details>
            <summary>üìã What's in staging</summary>

            ${changelog}

            </details>

            **Next:** Test on staging, then create release tag \`git tag v${version} && git push --tags\`

            ---
            <sub>ü§ñ [View logs](${runUrl}) ‚Ä¢ Staging auto-deploys on merge to main</sub>`;

            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body
            });

  # =============================================================================
  # E2E STAGING - Test on beta.villa.cash
  # =============================================================================
  e2e-staging:
    name: "üß™ E2E (Staging)"
    needs: deploy-staging
    if: needs.deploy-staging.outputs.url
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter @villa/web exec playwright install --with-deps chromium

      - name: Wait for healthy staging
        run: |
          for i in {1..20}; do
            if curl -sf "https://beta.villa.cash/api/health" > /dev/null; then
              echo "‚úÖ Staging healthy"
              exit 0
            fi
            sleep 10
          done
          exit 1

      - name: Run E2E tests on staging
        run: pnpm run test:e2e:chromium
        env:
          BASE_URL: https://beta.villa.cash
          CI: true

      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report-staging
          path: playwright-report/
          retention-days: 7

  # =============================================================================
  # PRODUCTION CI - Runs on release tags (v*)
  # =============================================================================
  ci-production:
    name: "üîí CI (Production)"
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      - uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
      - run: pnpm install --frozen-lockfile
      - run: pnpm run typecheck & pnpm run lint & wait
      - run: pnpm --filter @villa/web exec vitest run --config vitest.config.unit.ts
      - run: pnpm --filter @villa/web exec playwright install --with-deps chromium
        if: steps.playwright-cache.outputs.cache-hit != 'true'
      - run: pnpm --filter @villa/web exec playwright install-deps chromium
        if: steps.playwright-cache.outputs.cache-hit == 'true'
      - run: pnpm --filter @villa/web exec playwright test --project=chromium
        env:
          CI: true

  # =============================================================================
  # DEPLOY PRODUCTION - To villa.cash on release tags only
  # =============================================================================
  deploy-production:
    name: "üéâ Deploy Production"
    needs: ci-production
    if: needs.ci-production.result == 'success'
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    environment:
      name: production
      url: https://villa.cash
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Get release info
        id: release-info
        run: |
          TAG_NAME="${{ github.ref_name }}"
          CHANGELOG=$(git log --oneline -10 --pretty=format:"- %s" | head -10)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "version=${TAG_NAME#v}" >> $GITHUB_OUTPUT
          echo "tag=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Deploy to villa.cash
        id: deploy
        run: |
          START_TIME=$(date +%s)
          APP_ID=$(doctl apps list --format ID,Spec.Name --no-header | grep "villa-production$" | awk '{print $1}')

          if [ -z "$APP_ID" ]; then
            echo "üÜï Creating production app..."
            doctl apps create --spec .do/app-production.yaml
          else
            echo "üì¶ Updating production app..."
            doctl apps update $APP_ID --spec .do/app-production.yaml

            # Force rebuild to ensure new code is deployed (fixes cache issues)
            echo "üî® Forcing rebuild with --force-rebuild..."
            doctl apps create-deployment $APP_ID --force-rebuild --wait=false
          fi

          # Wait for deployment
          for i in {1..30}; do
            APP_ID=$(doctl apps list --format ID,Spec.Name --no-header | grep "villa-production$" | awk '{print $1}')
            if [ -n "$APP_ID" ]; then
              APP_JSON=$(doctl apps get $APP_ID --output json 2>/dev/null || echo '[]')
              IN_PROGRESS=$(echo "$APP_JSON" | jq -r '.[0].in_progress_deployment.phase // empty')
              if [ -n "$IN_PROGRESS" ]; then
                echo "üî® Building: $IN_PROGRESS ($i/30)"
                sleep 10
                continue
              fi
              ACTIVE_PHASE=$(echo "$APP_JSON" | jq -r '.[0].active_deployment.phase // empty')
              if [ "$ACTIVE_PHASE" = "ACTIVE" ]; then
                END_TIME=$(date +%s)
                DURATION=$((END_TIME - START_TIME))
                echo "url=https://villa.cash" >> $GITHUB_OUTPUT
                echo "duration=${DURATION}s" >> $GITHUB_OUTPUT
                exit 0
              fi
            fi
            sleep 10
          done
          exit 1

      - name: Purge CloudFlare cache
        if: steps.deploy.outcome == 'success'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          if [ -n "$CLOUDFLARE_API_TOKEN" ] && [ -n "$CLOUDFLARE_ZONE_ID" ]; then
            echo "üóëÔ∏è Purging CloudFlare cache for villa.cash..."
            pnpm run infra:cache:purge || echo "Cache purge failed (non-blocking)"
          else
            echo "‚ö†Ô∏è CloudFlare secrets not configured, skipping cache purge"
          fi

      - name: Create GitHub Release
        uses: actions/github-script@v7
        with:
          script: |
            const tag = '${{ steps.release-info.outputs.tag }}';
            const version = '${{ steps.release-info.outputs.version }}';
            const changelog = `${{ steps.release-info.outputs.changelog }}`;
            const sha = '${{ steps.release-info.outputs.sha }}';
            const duration = '${{ steps.deploy.outputs.duration }}';
            const actor = '${{ github.actor }}';

            const body = `## üéâ Villa ${tag}

            **Live at [villa.cash](https://villa.cash)**

            ### What's Changed
            ${changelog}

            ### Deployment Info
            - **Commit:** \`${sha}\`
            - **Deploy time:** ${duration}
            - **Deployed by:** @${actor}

            ---
            Full changelog: https://github.com/${context.repo.owner}/${context.repo.repo}/compare/...${tag}`;

            // Create GitHub Release
            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: `Villa ${tag}`,
              body,
              draft: false,
              prerelease: false
            });

  # =============================================================================
  # E2E PRODUCTION - Test on villa.cash
  # =============================================================================
  e2e-production:
    name: "üß™ E2E (Production)"
    needs: deploy-production
    if: needs.deploy-production.outputs.url
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter @villa/web exec playwright install --with-deps chromium

      - name: Wait for healthy production
        run: |
          for i in {1..20}; do
            if curl -sf "https://villa.cash/api/health" > /dev/null; then
              echo "‚úÖ Production healthy"
              exit 0
            fi
            sleep 10
          done
          exit 1

      - name: Run E2E tests on production
        run: pnpm run test:e2e:chromium
        env:
          BASE_URL: https://villa.cash
          CI: true

      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report-production
          path: playwright-report/
          retention-days: 7

  # =============================================================================
  # CLEANUP PREVIEW - Frees up dev slot
  # =============================================================================
  cleanup-preview:
    name: "üóëÔ∏è Cleanup Preview"
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Calculate slot
        id: slot
        run: |
          PR_NUM=${{ github.event.pull_request.number }}
          SLOT=$(( (PR_NUM % 2) + 1 ))
          echo "slot=${SLOT}" >> $GITHUB_OUTPUT

      - name: Comment cleanup
        uses: actions/github-script@v7
        with:
          script: |
            const merged = context.payload.pull_request.merged;
            const slot = '${{ steps.slot.outputs.slot }}';
            const emoji = merged ? 'üéâ' : 'üëã';
            const status = merged ? 'merged' : 'closed';

            const body = `${emoji} **PR ${status}** - dev-${slot}.villa.cash slot freed.

            ${merged ? '‚úÖ Changes are now on [beta.villa.cash](https://beta.villa.cash) (staging).\n\nCreate release tag to deploy to production.' : 'No changes deployed.'}`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
