name: Deploy to DigitalOcean

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, closed, ready_for_review]

permissions:
  contents: write
  pull-requests: write
  deployments: write

concurrency:
  group: deploy-${{ github.event_name == 'pull_request' && github.event.pull_request.number || 'production' }}
  cancel-in-progress: true

env:
  # Production domain (CloudFlare DNS)
  PRODUCTION_DOMAIN: villa.cash
  PRODUCTION_URL: https://villa.cash
  # Delightful GIFs for bot messages
  GIF_SHIP: "https://media.giphy.com/media/ule4vhcY1xEKQ/giphy.gif"
  GIF_SUCCESS: "https://media.giphy.com/media/XreQmk7ETCak0/giphy.gif"
  GIF_THINKING: "https://media.giphy.com/media/3o7TKwmnDgQb5jemjK/giphy.gif"
  GIF_CELEBRATE: "https://media.giphy.com/media/l0MYt5jPR6QX5pnqM/giphy.gif"
  GIF_ROCKET: "https://media.giphy.com/media/mi6DsSSNKDbUY/giphy.gif"

jobs:
  # =============================================================================
  # QUICK CI - Always runs for PRs (fast feedback ~30s)
  # =============================================================================
  quick-ci:
    name: "‚ö° Quick CI"
    if: github.event_name == 'pull_request' && github.event.action != 'closed'
    runs-on: ubuntu-latest
    outputs:
      should-e2e: ${{ steps.check-paths.outputs.run }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
          key: nextjs-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/*.ts', '**/*.tsx') }}
          restore-keys: |
            nextjs-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-
            nextjs-${{ runner.os }}-

      - run: npm ci

      - name: TypeScript check
        run: npm run typecheck

      - name: Lint
        run: npm run lint

      - name: Unit tests
        run: npx vitest run --config vitest.config.unit.ts

      - name: Check if E2E needed
        id: check-paths
        run: |
          CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD 2>/dev/null || echo "src/")
          if echo "$CHANGED" | grep -qE '^(src/|tests/|playwright|package)'; then
            echo "run=true" >> $GITHUB_OUTPUT
          else
            echo "run=false" >> $GITHUB_OUTPUT
            echo "üìù Skipping E2E - only docs/config changes"
          fi

  # =============================================================================
  # E2E TESTS - Sharded for parallel execution
  # =============================================================================
  e2e-tests:
    name: "üß™ E2E (${{ matrix.shard }})"
    needs: quick-ci
    if: |
      github.event_name == 'pull_request' &&
      github.event.action != 'closed' &&
      github.event.pull_request.draft == false &&
      needs.quick-ci.outputs.should-e2e == 'true' &&
      !contains(github.event.pull_request.title, '[wip]') &&
      !contains(github.event.pull_request.title, '[skip e2e]')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps chromium

      - name: Install Playwright deps (if cached)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium

      - name: Run E2E tests (shard ${{ matrix.shard }}/2)
        run: npx playwright test --project=chromium --shard=${{ matrix.shard }}/2
        env:
          CI: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-shard-${{ matrix.shard }}
          path: |
            playwright-report/
            test-results/
          retention-days: 7

  # =============================================================================
  # E2E RESULTS - Merge sharded results
  # =============================================================================
  e2e-results:
    name: "üìä E2E Results"
    needs: e2e-tests
    if: always() && needs.e2e-tests.result != 'skipped'
    runs-on: ubuntu-latest
    steps:
      - name: Download all shard reports
        uses: actions/download-artifact@v4
        with:
          pattern: playwright-report-shard-*
          merge-multiple: true

      - name: Merge reports
        run: |
          echo "üìä E2E Test Results"
          echo "==================="
          if [ -f test-results.json ]; then
            cat test-results.json | jq -r '.suites[] | .title + ": " + (.specs | length | tostring) + " tests"' 2>/dev/null || echo "Results merged"
          fi

      - name: Check overall status
        if: needs.e2e-tests.result == 'failure'
        run: exit 1

  # =============================================================================
  # CHECK PERMISSION - For preview deploys
  # =============================================================================
  check-permission:
    name: "üîê Check Permission"
    if: |
      github.event_name == 'pull_request' &&
      github.event.action != 'closed' &&
      github.event.pull_request.draft == false &&
      !contains(github.event.pull_request.title, '[skip deploy]')
    runs-on: ubuntu-latest
    outputs:
      is-collaborator: ${{ steps.check.outputs.is-collaborator }}
    steps:
      - name: Check if PR author is collaborator
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const { data: permissionLevel } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: context.payload.pull_request.user.login
            });
            const hasAccess = ['admin', 'write', 'maintain'].includes(permissionLevel.permission);
            core.setOutput('is-collaborator', hasAccess);

  # =============================================================================
  # DEPLOY PREVIEW - With delightful messages!
  # =============================================================================
  deploy-preview:
    name: "üöÄ Deploy Preview"
    needs: [quick-ci, check-permission]
    if: |
      github.event_name == 'pull_request' &&
      github.event.action != 'closed' &&
      github.event.pull_request.draft == false &&
      needs.check-permission.outputs.is-collaborator == 'true' &&
      !contains(github.event.pull_request.title, '[skip deploy]')
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    environment:
      name: preview
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Get PR info
        id: pr-info
        run: |
          # Get commit messages for changelog
          COMMITS=$(git log --oneline origin/${{ github.base_ref }}..HEAD 2>/dev/null | head -5 || echo "Initial commit")
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Get short SHA
          echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Generate app spec
        run: |
          export PR_NUMBER="${{ github.event.pull_request.number }}"
          export BRANCH_NAME="${{ github.head_ref }}"
          envsubst < .do/app-preview.yaml > .do/app-preview-generated.yaml

      - name: Deploy to App Platform
        id: deploy
        run: |
          APP_NAME="villa-pr-${{ github.event.pull_request.number }}"
          START_TIME=$(date +%s)

          APP_ID=$(doctl apps list --format ID,Spec.Name --no-header | grep "${APP_NAME}$" | awk '{print $1}')

          if [ -n "$APP_ID" ]; then
            echo "Updating existing preview app: $APP_ID"
            doctl apps update $APP_ID --spec .do/app-preview-generated.yaml
          else
            echo "Creating new preview app..."
            doctl apps create --spec .do/app-preview-generated.yaml
          fi

          # Wait for URL
          for i in {1..30}; do
            APP_URL=$(doctl apps list --format DefaultIngress,Spec.Name --no-header | grep "${APP_NAME}$" | awk '{print $1}')
            if [ -n "$APP_URL" ] && [ "$APP_URL" != "null" ] && [ "$APP_URL" != "<nil>" ]; then
              END_TIME=$(date +%s)
              DURATION=$((END_TIME - START_TIME))
              echo "url=https://${APP_URL}" >> $GITHUB_OUTPUT
              echo "duration=${DURATION}s" >> $GITHUB_OUTPUT
              exit 0
            fi
            sleep 10
          done
          exit 1

      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const url = '${{ steps.deploy.outputs.url }}';
            const duration = '${{ steps.deploy.outputs.duration }}';
            const sha = '${{ steps.pr-info.outputs.sha }}';
            const commits = `${{ steps.pr-info.outputs.commits }}`;
            const branch = '${{ github.head_ref }}';
            const prTitle = context.payload.pull_request.title;
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            const body = `![Ship it!](https://media.giphy.com/media/ule4vhcY1xEKQ/giphy.gif)

            ## üöÄ Preview Ready!

            ### **[üîó Open Preview](${url})** ‚Üê Click to test!

            | | |
            |---|---|
            | üåø **Branch** | \`${branch}\` |
            | üìù **Commit** | \`${sha}\` |
            | ‚è±Ô∏è **Deploy time** | ${duration} |

            <details>
            <summary>üìã Recent commits</summary>

            \`\`\`
            ${commits}
            \`\`\`

            </details>

            ---
            <sub>ü§ñ Preview auto-deletes when PR closes ‚Ä¢ [View Logs](${runUrl})</sub>`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c => c.user.type === 'Bot' && c.body.includes('Preview Ready'));

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body
              });
            }

  # =============================================================================
  # E2E PREVIEW - With result comment
  # =============================================================================
  e2e-preview:
    name: "üß™ E2E (Preview)"
    needs: deploy-preview
    if: needs.deploy-preview.outputs.url
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci
      - run: npx playwright install --with-deps chromium

      - name: Wait for healthy deployment
        id: health
        run: |
          URL="${{ needs.deploy-preview.outputs.url }}"
          for i in {1..20}; do
            if curl -sf "$URL/api/health" > /dev/null; then
              echo "healthy=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            sleep 10
          done
          echo "healthy=false" >> $GITHUB_OUTPUT
          exit 1

      - name: Run E2E tests
        id: e2e
        run: npm run test:e2e:chromium 2>&1 | tee e2e-output.txt
        env:
          BASE_URL: ${{ needs.deploy-preview.outputs.url }}
          CI: true
        continue-on-error: true

      - name: Comment E2E results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const passed = '${{ steps.e2e.outcome }}' === 'success';
            const url = '${{ needs.deploy-preview.outputs.url }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            let body;
            if (passed) {
              body = `![Tests passing](https://media.giphy.com/media/XreQmk7ETCak0/giphy.gif)

              ## ‚úÖ E2E Tests Passing!

              All tests passed against the preview deployment.

              | | |
              |---|---|
              | üåê **Tested URL** | [${url}](${url}) |
              | üìä **Full Report** | [View Logs](${runUrl}) |

              ---
              <sub>ü§ñ Tests ran automatically on preview deploy</sub>`;
            } else {
              body = `![Tests need attention](https://media.giphy.com/media/3o7TKwmnDgQb5jemjK/giphy.gif)

              ## ‚ùå E2E Tests Need Attention

              Some tests failed on the preview deployment.

              | | |
              |---|---|
              | üåê **Tested URL** | [${url}](${url}) |
              | üìä **Full Report** | [View Logs](${runUrl}) |
              | üì• **Artifacts** | Download from workflow run |

              <details>
              <summary>üîß Quick fixes</summary>

              - Check if the feature works manually at the preview URL
              - Review the Playwright report artifact
              - Run \`npm run test:e2e:ui\` locally to debug

              </details>

              ---
              <sub>ü§ñ Don't worry, you can re-run tests after fixing!</sub>`;
            }

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c => c.user.type === 'Bot' && c.body.includes('E2E Tests'));

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body
              });
            }

      - name: Upload report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report-pr-${{ github.event.pull_request.number }}
          path: playwright-report/
          retention-days: 7

      - name: Fail if tests failed
        if: steps.e2e.outcome != 'success'
        run: exit 1

  # =============================================================================
  # PRODUCTION CI - With caching for speed
  # =============================================================================
  ci-production:
    name: "üîí CI (Production)"
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: nextjs-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/*.ts', '**/*.tsx') }}
          restore-keys: |
            nextjs-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-
            nextjs-${{ runner.os }}-

      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - run: npm ci

      - name: Quick checks (parallel)
        run: |
          npm run typecheck &
          npm run lint &
          wait

      - run: npx vitest run --config vitest.config.unit.ts

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps chromium

      - name: Install Playwright deps (if cached)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium

      - name: E2E tests (parallel shards)
        run: npx playwright test --project=chromium
        env:
          CI: true

  # =============================================================================
  # DEPLOY PRODUCTION - With changelog!
  # =============================================================================
  deploy-production:
    name: "üéâ Deploy Production"
    needs: ci-production
    if: needs.ci-production.result == 'success'
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get release info
        id: release-info
        run: |
          # Get recent commits for changelog
          CHANGELOG=$(git log --oneline -10 --pretty=format:"- %s" | head -10)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Get version from package.json
          VERSION=$(node -p "require('./package.json').version")
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

          # Get short SHA
          echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Deploy to App Platform
        id: deploy
        run: |
          START_TIME=$(date +%s)
          APP_ID=$(doctl apps list --format ID,Spec.Name --no-header | grep "villa-production$" | awk '{print $1}')

          if [ -z "$APP_ID" ]; then
            doctl apps create --spec .do/app-production.yaml
          else
            doctl apps update $APP_ID --spec .do/app-production.yaml
          fi

          # Wait for deployment (JSON output for reliability)
          # Note: doctl apps get returns an array, use .[0] to access the app object
          APP_ID=$(doctl apps list --format ID,Spec.Name --no-header | grep "villa-production$" | awk '{print $1}')
          for i in {1..30}; do
            APP_JSON=$(doctl apps get $APP_ID --output json 2>/dev/null || echo '[]')

            IN_PROGRESS=$(echo "$APP_JSON" | jq -r '.[0].in_progress_deployment.phase // empty')
            if [ -n "$IN_PROGRESS" ]; then
              echo "üî® Building: $IN_PROGRESS ($i/30)"
              sleep 10
              continue
            fi

            ACTIVE_PHASE=$(echo "$APP_JSON" | jq -r '.[0].active_deployment.phase // empty')
            if [ "$ACTIVE_PHASE" = "ACTIVE" ]; then
              # default_ingress already includes https://
              APP_URL=$(echo "$APP_JSON" | jq -r '.[0].default_ingress // empty')
              END_TIME=$(date +%s)
              DURATION=$((END_TIME - START_TIME))
              echo "url=${APP_URL}" >> $GITHUB_OUTPUT
              echo "duration=${DURATION}s" >> $GITHUB_OUTPUT
              exit 0
            fi
            sleep 10
          done
          exit 1

      - name: Create GitHub Release comment
        uses: actions/github-script@v7
        with:
          script: |
            const url = '${{ steps.deploy.outputs.url }}';
            const duration = '${{ steps.deploy.outputs.duration }}';
            const version = '${{ steps.release-info.outputs.version }}';
            const sha = '${{ steps.release-info.outputs.sha }}';
            const changelog = `${{ steps.release-info.outputs.changelog }}`;
            const actor = '${{ github.actor }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            // Find the merge commit message or PR title
            const commitMsg = context.payload.head_commit?.message?.split('\n')[0] || 'Production deploy';

            const body = `![Deployed!](https://media.giphy.com/media/l0MYt5jPR6QX5pnqM/giphy.gif)

            ## üéâ Shipped to Production!

            ### **[üåê ${url}](${url})**

            | | |
            |---|---|
            | üì¶ **Version** | \`v${version}\` |
            | üìù **Commit** | \`${sha}\` - ${commitMsg} |
            | ‚è±Ô∏è **Deploy time** | ${duration} |
            | üë§ **Deployed by** | @${actor} |

            <details>
            <summary>üìã What's in this release</summary>

            ${changelog}

            </details>

            ---
            <sub>ü§ñ [View deployment logs](${runUrl}) ‚Ä¢ Villa v${version}</sub>`;

            // Post as a commit comment
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body
            });

  # =============================================================================
  # E2E PRODUCTION
  # =============================================================================
  e2e-production:
    name: "üß™ E2E (Production)"
    needs: deploy-production
    if: needs.deploy-production.outputs.url
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci
      - run: npx playwright install --with-deps chromium

      - name: Wait for healthy deployment
        run: |
          URL="${{ needs.deploy-production.outputs.url }}"
          for i in {1..20}; do
            if curl -sf "$URL/api/health" > /dev/null; then
              echo "‚úÖ Production healthy"
              exit 0
            fi
            sleep 10
          done
          exit 1

      - name: Run E2E tests
        run: npm run test:e2e:chromium
        env:
          BASE_URL: ${{ needs.deploy-production.outputs.url }}
          CI: true

      - name: Upload report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report-production
          path: playwright-report/
          retention-days: 7

  # =============================================================================
  # CLEANUP PREVIEW
  # =============================================================================
  cleanup-preview:
    name: "üóëÔ∏è Cleanup Preview"
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Delete preview app
        run: |
          APP_NAME="villa-pr-${{ github.event.pull_request.number }}"
          APP_ID=$(doctl apps list --format ID,Spec.Name --no-header | grep "${APP_NAME}$" | awk '{print $1}')

          if [ -n "$APP_ID" ]; then
            echo "üóëÔ∏è Deleting preview: ${APP_NAME}"
            doctl apps delete $APP_ID --force
          fi

      - name: Comment cleanup
        uses: actions/github-script@v7
        with:
          script: |
            const merged = context.payload.pull_request.merged;
            const emoji = merged ? 'üéâ' : 'üëã';
            const status = merged ? 'merged' : 'closed';

            const body = `${emoji} **Preview cleaned up** - PR was ${status}.

            ${merged ? 'Changes are now live in production!' : 'No changes were deployed.'}`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
