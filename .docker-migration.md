# Docker Setup Migration Guide

This guide helps you transition from the old fragmented docker-compose files to the new unified setup.

## What Changed?

### Old Setup (Deprecated)

Three separate docker-compose files:

1. `docker-compose.yml` - Production/development base
2. `docker-compose.dev.yml` - Full Docker development
3. `docker-compose.local.yml` - Hybrid local development

**Problems:**
- Duplication across files
- Unclear which file to use when
- Hard to maintain consistency
- Confusing for new developers

### New Setup (Unified)

Single `docker-compose.yml` with profiles:

- Default profile: Just PostgreSQL
- `dev`: PostgreSQL + Caddy HTTPS
- `https`: Caddy only
- `test`: Test environment
- `full`: Everything in containers

**Benefits:**
- Single source of truth
- Clear separation by use case
- Easier to understand and maintain
- Better developer experience

## Migration Steps

### 1. Stop Old Containers

```bash
# Stop any running containers from old setup
docker compose -f docker-compose.local.yml down
docker compose -f docker-compose.dev.yml down
docker compose down

# Or nuclear option
docker stop $(docker ps -aq)
```

### 2. Backup Database (Optional)

If you have important dev data:

```bash
# Backup before migrating
docker compose exec postgres pg_dump -U villa villa_dev > backup.sql

# After migration, restore if needed
cat backup.sql | docker compose exec -T postgres psql -U villa villa_dev
```

### 3. Update Environment Files

**Old:** No standard .env file

**New:** Use `.env.docker` as template

```bash
# Copy defaults
cp .env.docker .env

# Edit if needed
vim .env
```

**Key changes:**

| Old | New |
|-----|-----|
| Hardcoded in docker-compose.yml | Configurable via .env |
| Different per file | Unified variables |
| No defaults | Sensible defaults |

### 4. Update Scripts

**package.json changes:**

| Old Command | New Command | What It Does |
|-------------|-------------|--------------|
| `pnpm dev:docker` | `pnpm docker:dev` | Hybrid mode (db + https) |
| `pnpm dev:docker:down` | `pnpm docker:down` | Stop all services |
| N/A | `pnpm docker:https` | HTTPS proxy only |
| N/A | `pnpm docker:test` | Run tests in Docker |
| N/A | `pnpm docker:full` | Full containerized stack |

**Scripts still work:**

- `pnpm db:start` - Still starts postgres
- `pnpm db:stop` - Still stops postgres
- `pnpm db:reset` - Still resets database

### 5. Update Your Workflow

**Old workflow:**

```bash
# Hybrid local dev
pnpm dev:docker              # Start infrastructure
# Then manually run pnpm dev

# Stop
pnpm dev:docker:down
```

**New workflow:**

```bash
# Hybrid local dev (recommended)
pnpm docker:dev              # Start infrastructure
pnpm dev                     # Run Next.js natively

# Or one-liner (legacy compatibility)
pnpm dev:docker              # Does both

# Stop
pnpm docker:down
```

**Old workflow:**

```bash
# Full Docker
docker compose -f docker-compose.dev.yml up -d
```

**New workflow:**

```bash
# Full Docker
pnpm docker:full
```

### 6. Verify Migration

```bash
# Check services are running
pnpm docker:ps

# Check postgres health
docker compose ps postgres
# Should show "healthy"

# Test connection
docker compose exec postgres psql -U villa -d villa_dev -c "SELECT version();"

# Check logs
pnpm docker:logs
```

## File Mapping

### Old Files â†’ New Profiles

| Old File | New Command | Profile |
|----------|-------------|---------|
| `docker-compose.yml` (base) | `docker compose up -d` | Default |
| `docker-compose.local.yml` | `pnpm docker:dev` | `dev` |
| `docker-compose.dev.yml` | `pnpm docker:full` | `full` |

### Caddyfile Mapping

| Old File | New Usage | When |
|----------|-----------|------|
| `Caddyfile` | Production (unchanged) | Deployed environments |
| `Caddyfile.local` | `CADDYFILE=./Caddyfile.local` | Hybrid mode (default) |
| `Caddyfile.dev` | `CADDYFILE=./Caddyfile.dev` | Full Docker mode |

## Breaking Changes

### 1. Profile Required for HTTPS

**Old:**

```bash
docker compose -f docker-compose.local.yml up -d
```

Caddy started automatically.

**New:**

```bash
docker compose up -d
```

Only postgres starts.

```bash
docker compose --profile dev up -d
# or
pnpm docker:dev
```

Postgres + Caddy start.

**Why:** Default profile is minimal. Opt-in to HTTPS when needed.

### 2. Environment Variables

**Old:** Hardcoded in docker-compose files

**New:** Configurable via .env

If you had custom values in docker-compose files, move them to `.env`:

```bash
# .env
POSTGRES_PASSWORD=my_custom_password
APP_MEM_LIMIT=8g
```

### 3. Service Names

**Changed names:**

| Old | New |
|-----|-----|
| `https-proxy` | `caddy` |
| `web` | `app` |

**If you have scripts referencing old names:**

```bash
# Old
docker compose exec https-proxy sh

# New
docker compose exec caddy sh
```

## Rollback Plan

If you need to revert to old setup:

### 1. Restore Old Files

Old files were NOT deleted. They still exist:

- `docker-compose.dev.yml`
- `docker-compose.local.yml`

### 2. Use Old Commands

```bash
# Hybrid mode
docker compose -f docker-compose.local.yml up -d

# Full mode
docker compose -f docker-compose.dev.yml up -d
```

### 3. Revert package.json (if needed)

```bash
git checkout HEAD -- package.json
```

## Common Issues

### "Service 'app' depends on service 'postgres' which is undefined"

**Cause:** Profile not specified

**Fix:**

```bash
# Wrong
docker compose up test-e2e

# Right
docker compose --profile test up test-e2e
```

### "Port 5432 already in use"

**Cause:** Old postgres container still running

**Fix:**

```bash
# List all containers
docker ps -a | grep postgres

# Stop old container
docker stop villa-postgres

# Or remove it
docker rm -f villa-postgres
```

### "Caddy health check failing"

**Cause:** Wrong Caddyfile for mode

**Fix:**

```bash
# For hybrid mode (Next.js on host)
export CADDYFILE=./Caddyfile.local

# For full Docker mode (Next.js in container)
export CADDYFILE=./Caddyfile.dev

# Restart
docker compose restart caddy
```

## FAQ

**Q: Do I need to delete old docker-compose files?**

A: No. They're kept for backward compatibility. New setup is now the default.

**Q: Will this affect my database data?**

A: No. Volume names are the same (`villa-postgres-data`). Your data is preserved.

**Q: Can I use old and new setup simultaneously?**

A: Not recommended. Pick one to avoid port conflicts and confusion.

**Q: What about CI/CD?**

A: CI uses the unified docker-compose.yml with `test` profile. No changes needed.

**Q: Should I update .gitignore?**

A: No. `.env` is already gitignored. `.env.docker` is checked in as template.

## Deprecation Timeline

| Date | Status |
|------|--------|
| 2026-01-10 | Unified setup introduced |
| 2026-01-10+ | Both old and new work (transition period) |
| TBD | Old files removed (after all devs migrate) |

## Get Help

If you encounter issues during migration:

1. Check [DOCKER.md](DOCKER.md) for detailed docs
2. Try the quick reference: `.docker-quick-ref.md`
3. Open an issue with:
   - What you were trying to do
   - Command you ran
   - Error message
   - Output of `docker compose ps`

## Summary

**Before:**
- 3 docker-compose files
- Unclear which to use
- No environment file

**After:**
- 1 docker-compose file with profiles
- Clear use cases
- Configurable via .env

**Migration checklist:**

- [ ] Stop old containers
- [ ] Backup database (optional)
- [ ] Copy .env.docker to .env
- [ ] Update your workflow/scripts
- [ ] Test postgres: `pnpm docker:ps`
- [ ] Test dev mode: `pnpm docker:dev && pnpm dev`
- [ ] Test HTTPS: `open https://local.villa.cash`
- [ ] Read DOCKER.md for full guide
